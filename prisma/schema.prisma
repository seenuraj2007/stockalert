generator client {
  provider = "prisma-client-js"
  output   = "./generated/client"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                        String   @id @default(uuid())
  email                     String   @unique
  name                      String?
  passwordHash              String?  @map("password_hash")
  metadata                  Json?
  emailVerified             Boolean  @default(false) @map("email_verified")
  emailVerificationToken    String?  @map("email_verification_token")
  emailVerificationExpires  DateTime? @map("email_verification_expires")
  createdAt                 DateTime @default(now()) @map("created_at")
  updatedAt                 DateTime @updatedAt @map("updated_at")

  members Member[]
  passwordResetTokens PasswordResetToken[]
  oauthAccounts OAuthAccount[]

  @@index([emailVerificationToken])
  @@map("users")
}

model OAuthAccount {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  provider     String   // google, github, etc.
  providerAccountId String @map("provider_account_id")
  accessToken  String?  @map("access_token")
  refreshToken String?  @map("refresh_token")
  expiresAt    DateTime? @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("oauth_accounts")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  usedAt    DateTime? @map("used_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("password_reset_tokens")
}

model Tenant {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  ownerId     String   @unique @map("owner_id")
  settings    Json?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  locations       Location[]
  products        Product[]
  stockLevels     StockLevel[]
  stockTransfers  StockTransfer[]
  inventoryEvents InventoryEvent[]
  purchaseOrders  PurchaseOrder[]
  members         Member[]
  whatsappSettings WhatsAppSettings?
  productSettings ProductSettings?
  invoices       Invoice[]
  customers     Customer[]
  batches        Batch[]
  serialNumbers  SerialNumber[]
  stockTakes     StockTake[]
  auditLogs      AuditLog[]

  @@map("tenants")
}

model Member {
  id          String      @id @default(uuid())
  tenantId    String      @map("tenant_id")
  userId      String      @map("user_id")
  role        UserRole    @default(MEMBER)
  status      MemberStatus @default(ACTIVE)
  invitedBy   String?     @map("invited_by")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@index([tenantId])
  @@index([userId])
  @@map("members")
}

enum UserRole {
  OWNER
  ADMIN
  EDITOR
  VIEWER
  MEMBER
}

enum MemberStatus {
  ACTIVE
  INVITED
  SUSPENDED
}

model Location {
  id          String       @id @default(uuid())
  tenantId    String       @map("tenant_id")
  name        String
  type        LocationType @default(WAREHOUSE)
  address     String?      @db.Text
  city        String?
  state       String?
  zip         String?
  country     String?
  isPrimary   Boolean      @default(false) @map("is_primary")
  isActive    Boolean      @default(true) @map("is_active")
  deletedAt   DateTime?    @map("deleted_at")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  stockLevels   StockLevel[]
  transfersFrom StockTransfer[] @relation("from_location")
  transfersTo   StockTransfer[] @relation("to_location")
  stockTakes    StockTake[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@map("locations")
}

enum LocationType {
  WAREHOUSE
  STORE
  VIRTUAL
}

model Product {
  id            String           @id @default(uuid())
  tenantId      String           @map("tenant_id")
  sku           String
  barcode       String?          @unique
  name          String
  description   String?          @db.Text
  unitCost      Decimal          @map("unit_cost") @db.Decimal(12, 2)
  sellingPrice  Decimal          @map("selling_price") @db.Decimal(12, 2)
  category      String?
  unit          String           @default("unit")
  imageUrl      String?          @map("image_url")
  imageKey      String?          @map("image_key")
  supplierName  String?          @map("supplier_name")
  supplierEmail String?          @map("supplier_email")
  supplierPhone String?          @map("supplier_phone")
  
  // GST Fields
  hsnCode       String?          @map("hsn_code")
  gstRate       Decimal          @default(0) @map("gst_rate") @db.Decimal(5, 2)
  
  isActive      Boolean          @default(true) @map("is_active")
  deletedAt     DateTime?        @map("deleted_at")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")
  version       Int              @default(0)

  tenant           Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  stockLevels      StockLevel[]
  inventoryEvents  InventoryEvent[]
  orderItems       PurchaseOrderItem[]
  invoiceItems     InvoiceItem[]
  batches          Batch[]
  serialNumbers    SerialNumber[]
  stockTakeItems   StockTakeItem[]

  @@unique([tenantId, sku])
  @@index([tenantId])
  @@index([tenantId, barcode])
  @@index([tenantId, category])
  @@index([tenantId, isActive])
  @@map("products")
}

model StockLevel {
  id               String  @id @default(uuid())
  tenantId         String  @map("tenant_id")
  productId        String  @map("product_id")
  locationId       String  @map("location_id")
  quantity         Int     @default(0)
  reservedQuantity Int     @default(0) @map("reserved_quantity")
  reorderPoint     Int     @default(0) @map("reorder_point")
  version          Int     @default(0)
  updatedAt        DateTime @updatedAt @map("updated_at")

  tenant         Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product        Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  location       Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  batches        Batch[]
  serialNumbers  SerialNumber[]

  @@unique([tenantId, productId, locationId])
  @@index([tenantId])
  @@index([tenantId, productId])
  @@index([tenantId, locationId])
  @@map("stock_levels")
}

model StockTransfer {
  id            String        @id @default(uuid())
  tenantId      String        @map("tenant_id")
  fromLocationId String       @map("from_location_id")
  toLocationId  String        @map("to_location_id")
  productId     String        @map("product_id")
  quantity      Int
  status        TransferStatus @default(PENDING)
  requestedBy   String        @map("requested_by")
  completedBy   String?       @map("completed_by")
  notes         String?       @db.Text
  completedAt   DateTime?     @map("completed_at")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  fromLocation Location @relation("from_location", fields: [fromLocationId], references: [id])
  toLocation Location @relation("to_location", fields: [toLocationId], references: [id])

  @@index([tenantId, status])
  @@index([tenantId, fromLocationId])
  @@index([tenantId, toLocationId])
  @@map("stock_transfers")
}

enum TransferStatus {
  PENDING
  IN_TRANSIT
  COMPLETED
  CANCELLED
}

model PurchaseOrder {
  id          String    @id @default(uuid())
  tenantId    String    @map("tenant_id")
  orderNumber String    @unique @map("order_number")
  supplierName String   @map("supplier_name")
  supplierEmail String? @map("supplier_email")
  supplierPhone String? @map("supplier_phone")
  status      POStatus  @default(DRAFT)
  totalAmount Decimal   @map("total_amount") @db.Decimal(12, 2) @default(0)
  notes       String?   @db.Text
  orderedBy   String?   @map("ordered_by")
  orderedAt   DateTime? @map("ordered_at")
  receivedBy  String?   @map("received_by")
  receivedAt  DateTime? @map("received_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  tenant Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  items  PurchaseOrderItem[]

  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@map("purchase_orders")
}

enum POStatus {
  DRAFT
  ORDERED
  PARTIAL
  RECEIVED
  CANCELLED
}

model PurchaseOrderItem {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  orderId     String   @map("order_id")
  productId   String   @map("product_id")
  quantity    Int
  receivedQty Int      @default(0) @map("received_qty")
  unitCost    Decimal  @map("unit_cost") @db.Decimal(12, 2)
  totalCost   Decimal  @map("total_cost") @db.Decimal(12, 2)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  order PurchaseOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product       @relation(fields: [productId], references: [id])

  @@index([tenantId, orderId])
  @@map("purchase_order_items")
}

model InventoryEvent {
  id            String    @id @default(uuid())
  tenantId      String    @map("tenant_id")
  type          EventType
  productId     String    @map("product_id")
  locationId    String?   @map("location_id")
  quantityDelta Int       @map("quantity_delta")
  runningBalance Int      @map("running_balance")
  referenceType String?   @map("reference_type")
  referenceId   String?   @map("reference_id")
  userId        String    @map("user_id")
  notes         String?   @db.Text
  metadata      Json?
  createdAt     DateTime  @default(now()) @map("created_at")

  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product Product   @relation(fields: [productId], references: [id])

  @@index([tenantId, productId, createdAt])
  @@index([tenantId, createdAt])
  @@index([tenantId, type])
  @@map("inventory_events")
}

enum EventType {
  STOCK_RECEIVED
  STOCK_SOLD
  ADJUSTMENT
  TRANSFER_IN
  TRANSFER_OUT
  RESTOCK
}

model Alert {
  id              String      @id @default(uuid())
  tenantId        String      @map("tenant_id")
  userId          String?     @map("user_id")
  type            AlertType
  message         String      @db.Text
  productId       String?     @map("product_id")
  locationId      String?     @map("location_id")
  referenceType   String?     @map("reference_type")
  referenceId     String?     @map("reference_id")
  isRead          Boolean     @default(false) @map("is_read")
  readAt          DateTime?   @map("read_at")
  sentAt          DateTime?   @map("sent_at")
  metadata        Json?
  createdAt       DateTime    @default(now()) @map("created_at")

  @@index([tenantId, userId])
  @@index([tenantId, isRead])
  @@map("alerts")
}

enum AlertType {
  LOW_STOCK
  OUT_OF_STOCK
  PURCHASE_ORDER
  STOCK_TRANSFER
  OVERSTOCK
}

model StockHistory {
  id                String              @id @default(uuid())
  tenantId          String              @map("tenant_id")
  productId         String              @map("product_id")
  locationId        String?             @map("location_id")
  previousQuantity  Int                 @map("previous_quantity")
  quantityChange    Int                 @map("quantity_change")
  newQuantity       Int                 @map("new_quantity")
  changeType        StockHistoryType    @map("change_type")
  referenceType     String?             @map("reference_type")
  referenceId       String?             @map("reference_id")
  userId            String?             @map("user_id")
  notes             String?             @db.Text
  createdAt         DateTime            @default(now()) @map("created_at")

  @@index([tenantId, productId, createdAt])
  @@index([tenantId, createdAt])
  @@map("stock_history")
}

enum StockHistoryType {
  ADD
  REMOVE
  RESTOCK
  TRANSFER_IN
  TRANSFER_OUT
  ADJUSTMENT
}

model WhatsAppSettings {
  id                    String    @id @default(uuid())
  tenantId              String    @unique @map("tenant_id")
  enabled               Boolean   @default(false)
  phoneNumber           String?   @map("phone_number")
  notifyLowStock        Boolean   @default(true) @map("notify_low_stock")
  notifyOutOfStock      Boolean   @default(true) @map("notify_out_of_stock")
  notifyPurchaseOrders  Boolean   @default(true) @map("notify_purchase_orders")
  notifyDailySummary    Boolean   @default(false) @map("notify_daily_summary")
  language              String    @default("en")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("whatsapp_settings")
}

model ProductSettings {
  id                  String    @id @default(uuid())
  tenantId            String    @unique @map("tenant_id")
  defaultReorderPoint Int       @default(10) @map("default_reorder_point")
  defaultUnit         String    @default("PCS") @map("default_unit")
  enableBarcodes      Boolean   @default(true) @map("enable_barcodes")
  trackExpiryDates    Boolean   @default(false) @map("track_expiry_dates")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("product_settings")
}

model Customer {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  name        String
  email       String?
  phone       String?
  address     String?  @db.Text
  city        String?
  state       String?
  pincode     String?
  gstNumber   String?  @map("gst_number")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoices  Invoice[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@map("customers")
}

model Invoice {
  id            String        @id @default(uuid())
  tenantId      String        @map("tenant_id")
  customerId    String?       @map("customer_id")
  invoiceNumber String        @unique @map("invoice_number")
  invoiceDate   DateTime      @map("invoice_date")
  dueDate       DateTime?     @map("due_date")
  status        InvoiceStatus @default(DRAFT)
  
  // Business Details
  businessName  String        @map("business_name")
  businessAddress String?     @map("business_address") @db.Text
  businessCity  String?       @map("business_city")
  businessState String?       @map("business_state")
  businessPincode String?     @map("business_pincode")
  businessGstNumber String?   @map("business_gst_number")
  
  // Customer Details
  customerName  String        @map("customer_name")
  customerAddress String?     @map("customer_address") @db.Text
  customerCity  String?       @map("customer_city")
  customerState String?       @map("customer_state")
  customerPincode String?     @map("customer_pincode")
  customerGstNumber String?   @map("customer_gst_number")
  
  // Financials
  subtotal      Decimal       @map("subtotal") @db.Decimal(12, 2)
  totalCgst     Decimal       @map("total_cgst") @db.Decimal(12, 2) @default(0)
  totalSgst     Decimal       @map("total_sgst") @db.Decimal(12, 2) @default(0)
  totalIgst     Decimal       @map("total_igst") @db.Decimal(12, 2) @default(0)
  totalGst      Decimal       @map("total_gst") @db.Decimal(12, 2) @default(0)
  totalAmount   Decimal       @map("total_amount") @db.Decimal(12, 2)
  
  // E-way Bill (placeholder)
  ewayBillNumber String?      @map("eway_bill_number")
  ewayBillDate  DateTime?     @map("eway_bill_date")
  
  // Notes
  notes         String?       @db.Text
  terms         String?       @db.Text
  
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  tenant      Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer    Customer?     @relation(fields: [customerId], references: [id])
  items       InvoiceItem[]
  receiptScans ReceiptScan[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, invoiceDate])
  @@map("invoices")
}

model InvoiceItem {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  invoiceId   String   @map("invoice_id")
  productId   String?  @map("product_id")
  description String
  hsnCode     String?  @map("hsn_code")
  quantity    Int
  unitPrice   Decimal  @map("unit_price") @db.Decimal(12, 2)
  discount    Decimal  @default(0) @map("discount") @db.Decimal(12, 2)
  taxableAmount Decimal @map("taxable_amount") @db.Decimal(12, 2)
  cgstRate    Decimal  @default(0) @map("cgst_rate") @db.Decimal(5, 2)
  sgstRate    Decimal  @default(0) @map("sgst_rate") @db.Decimal(5, 2)
  igstRate    Decimal  @default(0) @map("igst_rate") @db.Decimal(5, 2)
  cgstAmount  Decimal  @map("cgst_amount") @db.Decimal(12, 2) @default(0)
  sgstAmount  Decimal  @map("sgst_amount") @db.Decimal(12, 2) @default(0)
  igstAmount  Decimal  @map("igst_amount") @db.Decimal(12, 2) @default(0)
  totalAmount Decimal  @map("total_amount") @db.Decimal(12, 2)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])

  @@index([tenantId, invoiceId])
  @@map("invoice_items")
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
  OVERDUE
  CANCELLED
}

// =============================================================================
// HIGH PRIORITY FEATURES - Batch/Lot Tracking, Serial Numbers, Stock Take
// =============================================================================

// Batch/Lot Tracking - for pharmaceuticals, food, and regulated industries
model Batch {
  id               String   @id @default(uuid())
  tenantId         String   @map("tenant_id")
  productId        String   @map("product_id")
  stockLevelId     String?  @map("stock_level_id")
  batchNumber      String   @map("batch_number")
  
  // Dates
  manufacturingDate DateTime? @map("manufacturing_date")
  expiryDate       DateTime? @map("expiry_date")
  
  // Quantity tracking
  quantity         Int      @default(0)
  reservedQuantity Int      @default(0) @map("reserved_quantity")
  
  // Cost tracking
  unitCost         Decimal? @map("unit_cost") @db.Decimal(12, 2)
  
  // Status
  status           BatchStatus @default(ACTIVE)
  
  // Additional info
  supplierId       String?  @map("supplier_id")
  supplierBatchRef String?  @map("supplier_batch_ref")
  notes            String?  @db.Text
  
  // Audit
  receivedBy       String?  @map("received_by")
  receivedAt       DateTime? @map("received_at")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  tenant     Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  stockLevel StockLevel? @relation(fields: [stockLevelId], references: [id], onDelete: SetNull)
  serialNumbers SerialNumber[]

  @@unique([tenantId, productId, batchNumber])
  @@index([tenantId])
  @@index([tenantId, productId])
  @@index([tenantId, expiryDate])
  @@index([tenantId, status])
  @@map("batches")
}

enum BatchStatus {
  ACTIVE        // Currently in stock
  EXPIRED       // Past expiry date
  RECALLED      // Recalled by supplier/manufacturer
  QUARANTINE    // Under quality check
  DEPLETED      // All quantity used
}

// Serial Number Tracking - for electronics, high-value items, warranty tracking
model SerialNumber {
  id             String        @id @default(uuid())
  tenantId       String        @map("tenant_id")
  productId      String        @map("product_id")
  batchId        String?       @map("batch_id")
  stockLevelId   String?       @map("stock_level_id")
  
  // Serial info
  serialNumber   String        @map("serial_number")
  alternateSerial String?      @map("alternate_serial") // For manufacturer serial vs internal
  
  // Status
  status         SerialStatus  @default(IN_STOCK)
  
  // Warranty
  warrantyMonths Int?          @map("warranty_months")
  warrantyExpiry DateTime?     @map("warranty_expiry")
  
  // Cost
  unitCost       Decimal?      @map("unit_cost") @db.Decimal(12, 2)
  
  // Customer info (when sold)
  customerId     String?       @map("customer_id")
  soldAt         DateTime?     @map("sold_at")
  invoiceId      String?       @map("invoice_id")
  
  // Additional info
  notes          String?       @db.Text
  metadata       Json?
  
  // Audit
  createdBy      String?       @map("created_by")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  tenant     Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  batch      Batch?      @relation(fields: [batchId], references: [id], onDelete: SetNull)
  stockLevel StockLevel? @relation(fields: [stockLevelId], references: [id], onDelete: SetNull)

  @@unique([tenantId, productId, serialNumber])
  @@index([tenantId])
  @@index([tenantId, productId])
  @@index([tenantId, status])
  @@index([tenantId, customerId])
  @@map("serial_numbers")
}

enum SerialStatus {
  IN_STOCK       // Available for sale
  RESERVED       // Reserved for an order
  SOLD           // Sold to customer
  DEFECTIVE      // Damaged/defective
  RETURNED       // Customer returned
  IN_TRANSIT     // Being transferred
  QUARANTINE     // Under quality check
}

// Stock Take / Inventory Counting
model StockTake {
  id             String         @id @default(uuid())
  tenantId       String         @map("tenant_id")
  locationId     String         @map("location_id")
  
  // Reference
  referenceNumber String        @map("reference_number")
  
  // Status
  status         StockTakeStatus @default(DRAFT)
  
  // Scheduling
  scheduledDate  DateTime?      @map("scheduled_date")
  startedAt      DateTime?      @map("started_at")
  completedAt    DateTime?      @map("completed_at")
  
  // Summary
  totalItems     Int            @default(0) @map("total_items")
  countedItems   Int            @default(0) @map("counted_items")
  varianceItems  Int            @default(0) @map("variance_items")
  
  // Users
  createdBy      String         @map("created_by")
  supervisedBy   String?        @map("supervised_by")
  
  // Notes
  notes          String?        @db.Text
  
  // Audit
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  tenant   Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  location Location       @relation(fields: [locationId], references: [id], onDelete: Cascade)
  items    StockTakeItem[]

  @@unique([tenantId, referenceNumber])
  @@index([tenantId])
  @@index([tenantId, locationId])
  @@index([tenantId, status])
  @@map("stock_takes")
}

enum StockTakeStatus {
  DRAFT        // Created, not started
  IN_PROGRESS  // Counting in progress
  PENDING_REVIEW // Counting done, needs review
  COMPLETED    // Finalized and adjustments made
  CANCELLED    // Cancelled
}

model StockTakeItem {
  id             String   @id @default(uuid())
  stockTakeId    String   @map("stock_take_id")
  productId      String   @map("product_id")
  
  // Quantities
  systemQuantity Int      @map("system_quantity")  // What system says
  countedQuantity Int?    @map("counted_quantity") // What was actually counted
  variance       Int?     @map("variance") // Difference (counted - system) - computed in API
  
  // Batch/Serial tracking during count
  batchId        String?  @map("batch_id")
  serialNumbers  String?  @map("serial_numbers") // JSON array of serials counted
  
  // Counting details
  countedBy      String?  @map("counted_by")
  countedAt      DateTime? @map("counted_at")
  
  // Notes
  notes          String?  @db.Text
  
  // Audit
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  stockTake StockTake @relation(fields: [stockTakeId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([stockTakeId, productId])
  @@index([stockTakeId])
  @@index([productId])
  @@map("stock_take_items")
}

// Enhanced Audit Trail
model AuditLog {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  userId      String?  @map("user_id")
  
  // Action details
  action      String   // CREATE, UPDATE, DELETE, LOGIN, etc.
  entityType  String   @map("entity_type") // Product, Invoice, StockLevel, etc.
  entityId    String   @map("entity_id")
  
  // Changes
  oldValues   Json?    @map("old_values")
  newValues   Json?    @map("new_values")
  changedFields String? @map("changed_fields") // Array of field names that changed
  
  // Request context
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  requestUrl  String?  @map("request_url")
  requestMethod String? @map("request_method")
  
  // Additional metadata
  metadata    Json?
  
  // Timestamp
  createdAt   DateTime @default(now()) @map("created_at")

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, entityType, entityId])
  @@index([tenantId, createdAt])
  @@index([tenantId, userId])
  @@index([tenantId, action])
  @@map("audit_logs")
}

model ReceiptScan {
  id          String   @id @default(uuid())
  invoiceId   String   @map("invoice_id")
  tenantId    String   @map("tenant_id")
  
  // Scan metadata
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  referrer    String?  // Where scan came from
  
  // Timestamp
  scannedAt   DateTime @default(now()) @map("scanned_at")
  
  // Relations
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([invoiceId])
  @@index([tenantId])
  @@index([scannedAt])
  @@map("receipt_scans")
}
